<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Parse JSONp Prototype</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="Proof of concept">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="format-detection" content="telephone=no">
        <meta name="author" content="Isaac Shapira, Joe Hoeller">
        <!-- Meta for Live tiles for Windows -->
        <meta name="msapplication-TileImage" content="tile-background.png">
        <meta name="msapplication-TileColor" content="#FF0000">
        <link rel="stylesheet" href="styles.css" />

        <script>

            function appendParam(url, key, param){
                return url
                    + (url.indexOf("?") > 0 ? "&" : "?")
                    + key + "=" + param;
            }

            function createScript(url, callback){

                console.time("script creation");

                var script =
                    document
                    .createElement("script");

                script
                .setAttribute("src", url);

                document
                .head
                .appendChild(script);

                console.timeEnd("script creation");

                callback(function(){
                    setTimeout(function(){
                        document
                        .head
                        .removeChild(script);
                    }, 0);
                });
            }

            function jsonp(url, key, callback) {
                var q = "q" + Math.round(Math.random() * Date.now());
                createScript(
                    appendParam(url, key, q), function(remove){
                        window[q] = function(json){
                            console.time("cleanup")
                            window[q] = undefined;
                            remove();
                            callback(json);
                        }
                    });
            }
            console.time("round trip");
            jsonp(
                "http://api.flickr.com/services/feeds/photos_public.gne?tags=monkey&tagmode=any&format=json"
                , "jsoncallback", function(res){
                    console.timeEnd("cleanup");
                    console.timeEnd("round trip");
                    console.log(res);
                });


        </script>
    </head>
    <body></body>
</html>
